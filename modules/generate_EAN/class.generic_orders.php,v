head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2015.06.03.00.15.09;	author root;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@<?php

require_once( 'db_base.php' );
require_once( '../../includes/purchasing/includes/po_class.inc' );	//Purchase Order (cart)
require_once( '../../includes/ui/po_ui.inc' );				//read_po

class generic_orders extends db_base
//class generic_orders
{
	var $order_no;
        var $db_Host;
    	var $db_User;
    	var $db_Password;
    	var $db_Name;
    	var $last_order_no;
	var $vendor;
	var $tabs = array();
	var $found;
	var $purchase_order;
	/*********************************************************************
	 *
	 *	This function must be overridden to work correctly
	 *	The inheriting class MUST set customer_index_name,
	 *	customer_table_name and vendor
	 *
	 *********************************************************************/
	function __construct( $host, $user, $pass, $database, $pref_tablename )
	{
//		echo "Generic constructor pref_tablename: $pref_tablename";
		parent::__construct( $host, $user, $pass, $database, $pref_tablename );
		$this->vendor = "COAST";
		$this->purchase_order = new purch_order();


	}
	function install( $redirect_to = NULL )
	{
		$this->create_prefs_tablename();
        	$this->loadprefs();
        	$this->checkprefs();
		if( isset( $redirect_to ) )
		{
        		header("Location: " . $redirect_to );
		}
	}
/*
	function get_purchase_order()
	{
		//read_po is FA provided method for reading a PO.
		//purchase_order will have an array (line_items) of class po_line_details
		if( !isset( $this->order_no ) )
			return FALSE;
		if( !isset( $this->purchase_order ) )
			return FALSE;
                read_po($this->order_no, $this->purchase_order);
	}
*/
	function get_id_range()
	{
       		$sql = "SELECT MAX(`order_no`) as max FROM `" . $this->company_prefix . "purch_orders`";
    		$result = db_query($sql, "Couldn't get PO ID range" );
 		$this->order_no = max((int)$result['max'], $this->last_order_no+1);

    		return mysql_fetch_assoc($result);
	}
	function get_supplier_order()
	{
       		$sql = "SELECT o.order_no, s.supp_name, FROM `" . $this->company_prefix . "purch_orders` o, `" . $this->company_prefix . "suppliers` s where o.supplier_id = s.supplier_id";
    		$result = db_query($sql, "Couldn't get PO list" );
 		//$this->order_no = max((int)$result['min'], $this->last_order_no+1);
    		return mysql_fetch_assoc($result);
	}
	/*********************************************************************
	 *
	 *	This function must be overridden to work correctly
	 *	The inheriting class MUST set its SQL statement, as well as the
	 *	datasource specific processing into facust.
	 *
	 *********************************************************************/
	function export_orders()
	{
	//	if( !isset( $this->db_connection ) )
	//		$this->connect_db();	//connect to DB setting db_connection used below.
	}
	function loadprefs()
	{
		$this->loaddbprefs();

    		// Get last oID exported
    		$this->last_order_no = $this->get_pref('lastorder_no');
	}
	function loaddbprefs()
	{
    		// Get Host Name
        	 $this->db_Host = $this->get_pref('myhost');
    		// Get User Name
    		$this->db_User = $this->get_pref('myuser');
    		// Get Password
    		$this->db_Password = $this->get_pref('mypassword');
    		// Get DB Name
    		$this->db_Name = $this->get_pref('myname');
	}
	function checkprefs()
	{
		$this->checkdbprefs();
	}
	function checkdbprefs()
	{
		if (isset($_POST['dbHost'])) $dbHost = $_POST['dbHost'];
		if (isset($_POST['dbUser'])) $dbUser = $_POST['dbUser'];
		if (isset($_POST['dbPassword'])) $dbPassword = $_POST['dbPassword'];
		if (isset($_POST['dbName'])) $dbName = $_POST['dbName'];

		if ($dbHost != $this->db_Host) // If it changed
			$this->set_pref('myhost', $dbHost);
		if ($dbUser != $this->db_User) // If it changed
			$this->set_pref('myuser', $dbUser);
		if ($dbPassword != $this->db_Password) // If it changed
			$this->set_pref('mypassword', $dbPassword);
		if ($dbName != $this->db_Name) // If it changed
			$this->set_pref('myname', $dbName);
	}
	function action_show_form()
	{
		$this->action_show_db_form();
		end_page();
	}
	function action_show_db_form()
	{
		start_form(true);
	 	start_table(TABLESTYLE2, "width=40%");

		$th = array("Function", "Description");
		table_header($th);

		$k = 0;

		alt_table_row_color($k);

		label_cell("Table Status");
		if ($this->found) $table_st = "Found";
		else $table_st = "<font color=red>Not Found</font>";
		label_cell($table_st);
		end_row();

		text_row("Mysql Host", 'dbHost', $this->db_Host, 20, 40);
		text_row("User", 'dbUser', $this->db_User, 20, 40);
		text_row("Password", 'dbPassword', $this->db_Password, 20, 40);
		text_row("DB Name", 'dbName', $this->db_Name, 20, 40);

		end_table(1);


		if (!$this->found) {
		    hidden('action', 'create');
		    submit_center('create', 'Create Table');
		} else {
		    hidden('action', 'update');
		    submit_center('update', 'Update Mysql');
		}

		end_form();
	}
	function form_export()
	{
		 start_form(true);

		 start_table(TABLESTYLE2, "width=40%");

		 table_section_title("Export Purchase Order");

		 $company_record = get_company_prefs();

		$this->get_id_range();

		 text_row("Export " . $this->vendor . " Purchase Order ID:", 'order_no', $this->order_no, 10, 10);

		 end_table(1);

		 hidden('action', 'c_export');
		 submit_center('cexport', "Export  " . $this->vendor . " Purchase Orders");

		 end_form();
		end_page();
	}
	function related_tabs( $action )
	{
		foreach( $this->tabs as $tab )
		{
			if( $action == $tab['action'] )
			{
				echo $tab['title'];
			}
			else
			{
				hyperlink_params($_SERVER['PHP_SELF'], 
						_("&" .  $tab['title']), 
						"action=" . $tab['action'], 
						false);
			}
			echo '&nbsp;|&nbsp;';
		}
	}
	function show_form( $action )
	{
		foreach( $this->tabs as $tab )
		{
			if( $action == $tab['action'] )
			{
				//Call appropriate form
				$form = $tab['form'];
				$this->$form();
			}
		}
	}
	function base_page( $action, $help_context = "" )
	{
		page(_($help_context));
		//echo __FILE__ . ":" . __LINE__ . "<br />";
		$this->tabs[1]['title'] = 'Configuration';
		$this->tabs[1]['action'] = 'config';
		$this->tabs[1]['form'] = 'action_show_form';
		$this->tabs[2]['title'] = 'Purchase Order Export';
		$this->tabs[2]['action'] = 'cexport';
		$this->tabs[2]['form'] = 'form_export';
		$this->related_tabs( $action );
	}
}

?>
@
