head	1.3;
access;
symbols;
locks
	root:1.3; strict;
comment	@# @;


1.3
date	2015.11.27.19.28.06;	author root;	state Exp;
branches;
next	1.2;

1.2
date	2015.11.07.00.22.49;	author root;	state Exp;
branches;
next	1.1;

1.1
date	2015.06.03.00.15.09;	author root;	state Exp;
branches;
next	;


desc
@@


1.3
log
@update config_form data field to be 60 wide from 40
@
text
@<?php

require_once( '../ksf_modules_common/db_base.php' );
require_once( $path_to_root . '/purchasing/includes/po_class.inc' );	//Purchase Order (cart)
require_once( '../../purchasing/includes/ui/po_ui.inc' );				//read_po

class generic_orders extends db_base
//class generic_orders
{
	var $order_no;
        var $db_Host;
    	var $db_User;
    	var $db_Password;
    	var $db_Name;
    	var $last_order_no;
	var $vendor;
	var $tabs = array();
	var $found;
	var $purchase_order;
	var $config_values = array();	//What fields to be put on config screen
	var $help_context;
	var $action;			//for choosing what to do, forms
	var $redirect_to;		//script name to redirect to on install
	/*********************************************************************
	 *
	 *	This function must be overridden to work correctly
	 *	The inheriting class MUST set customer_index_name,
	 *	customer_table_name and vendor
	 *
	 *********************************************************************/
	function __construct( $host, $user, $pass, $database, $pref_tablename )
	{
//		echo "Generic constructor pref_tablename: $pref_tablename";
		parent::__construct( $host, $user, $pass, $database, $pref_tablename );
		$this->purchase_order = new purch_order();


	}
	function install()
	{
		$this->create_prefs_tablename();
        	$this->loadprefs();
        	$this->checkprefs();
		if( isset( $this->redirect_to ) )
		{
        		header("Location: " . $this->redirect_to );
		}
	}
	function get_purchase_order()
	{
		//read_po is FA provided method for reading a PO.
		//purchase_order will have an array (line_items) of class po_line_details
		if( !isset( $this->order_no ) )
			return FALSE;
		if( !isset( $this->purchase_order ) )
			return FALSE;
                read_po($this->order_no, $this->purchase_order);
	}
	function get_id_range()
	{
       		$sql = "SELECT MAX(`order_no`) as max FROM `" . $this->company_prefix . "purch_orders`";
    		$result = db_query($sql, "Couldn't get PO ID range" );
 		$this->order_no = max((int)$result['max'], $this->last_order_no+1);

    		return mysql_fetch_assoc($result);
	}
	function get_supplier_order()
	{
       		$sql = "SELECT o.order_no, s.supp_name, FROM `" . $this->company_prefix . "purch_orders` o, `" . $this->company_prefix . "suppliers` s where o.supplier_id = s.supplier_id";
    		$result = db_query($sql, "Couldn't get PO list" );
 		//$this->order_no = max((int)$result['min'], $this->last_order_no+1);
    		return mysql_fetch_assoc($result);
	}
	/*********************************************************************
	 *
	 *	This function must be overridden to work correctly
	 *	The inheriting class MUST set its SQL statement, as well as the
	 *	datasource specific processing into facust.
	 *
	 *********************************************************************/
	function export_orders()
	{
	//	if( !isset( $this->db_connection ) )
	//		$this->connect_db();	//connect to DB setting db_connection used below.
	}
	function loadprefs()
	{
    		// Get last oID exported
		foreach( $this->config_values as $row )
		{
			$this->set_var( $row['pref_name'], $this->get_pref( $row['pref_name'] ) );
		}
	}
	function updateprefs()
	{
		foreach( $this->config_values as $row )
		{
			if( isset( $_POST[$row['pref_name']] ) )
			{
				$this->set_var( $row['pref_name'], $_POST[ $row['pref_name'] ] );
				$this->set_pref( $row['pref_name'], $_POST[ $row['pref_name'] ] );
			}
		}
	}
	function checkprefs()
	{
		$this->updateprefs();
	}
	function action_show_form()
	{
		start_form(true);
	 	start_table(TABLESTYLE2, "width=40%");
		$th = array("Config Variable", "Value");
		table_header($th);
		$k = 0;
		alt_table_row_color($k);
			/* To show a labeled cell...*/
			//label_cell("Table Status");
			//if ($this->found) $table_st = "Found";
			//else $table_st = "<font color=red>Not Found</font>";
			//label_cell($table_st);
			//end_row();
		foreach( $this->config_values as $row )
		{
				text_row($row['label'], $row['pref_name'], $this->$row['pref_name'], 20, 60);
		}
		end_table(1);
		if (!$this->found) {
		    hidden('action', 'create');
		    submit_center('create', 'Create Table');
		} else {
		    hidden('action', 'update');
		    submit_center('update', 'Update Configuration');
		}
		end_form();
		
	}
	function form_export()
	{
		$selected_id = 1;
		$none_option = "";
		$submit_on_change = FALSE;
		$all = FALSE;
		$all_items = TRUE;
		$mode = 1;
		$spec_option = "";
		 start_form(true);

		 start_table(TABLESTYLE2, "width=40%");

		 table_section_title("Export Purchase Order");

		 $company_record = get_company_prefs();

		$this->get_id_range();

		$sql = "SELECT supp_name, order_no FROM " . $this->company_prefix . "purch_orders o, " . $this->company_prefix . "suppliers s where s.supplier_id = o.supplier_id";
		//echo combo_input("SupplierPO", $selected_id, $sql, 'supplier_id', 'supp_name',
/*
		echo combo_input("order_no2", $this->order_no, $sql, 'supp_name', 'order_no',
        		array(
                		//'format' => '_format_add_curr',
            			'order' => array('order_no'),
                		//'search_box' => $mode!=0,
                		'type' => 1,
        			//'search' => array("order_no","supp_name"),
                		//'spec_option' => $spec_option === true ? _("All Suppliers") : $spec_option,
                		'spec_id' => $all_items,
                		'select_submit'=> $submit_on_change,
                		'async' => false,
                		//'sel_hint' => $mode ? _('Press Space tab to filter by name fragment') :
                		//_('Select supplier'),
                		//'show_inactive'=>$all
                	)
		);
*/

		 text_row("Export " . $this->vendor . " Purchase Order ID:", 'order_no', $this->order_no, 10, 10);

		 end_table(1);

		 hidden('action', 'c_export');
		 submit_center('cexport', "Export  " . $this->vendor . " Purchase Orders");

		 end_form();
	}
	function related_tabs()
	{
		$action = $this->action;
		foreach( $this->tabs as $tab )
		{
			if( $action == $tab['action'] )
			{
				echo $tab['title'];
				echo '&nbsp;|&nbsp;';
			}
			else
			{
				if( $tab['hidden'] == FALSE )
				{
					hyperlink_params($_SERVER['PHP_SELF'], 
						_("&" .  $tab['title']), 
						"action=" . $tab['action'], 
						false);
					echo '&nbsp;|&nbsp;';
				}
			}
		}
	}
	function show_form()
	{
		$action = $this->action;
		foreach( $this->tabs as $tab )
		{
			if( $action == $tab['action'] )
			{
				//Call appropriate form
				$form = $tab['form'];
				$this->$form();
			}
		}
	}
	function base_page()
	{
		page(_($this->help_context));
		$this->related_tabs();
	}
	function display()
	{
		$this->base_page();
		$this->show_form();
		end_page();
	}
	function run()
	{
		if ($this->found) {
		        $this->loadprefs();
		}
		else
		{
		        $this->install();
		        $this->set_var( 'action', "show" );
		}
		
		if (isset($_POST['action']))
		{
		        $this->set_var( 'action', $_POST['action'] );
		}
		if (isset($_GET['action']) && $this->found)
		{
		        $this->set_var( 'action', $_GET['action'] );
		}

		$this->display();
	}
}

?>
@


1.2
log
@adjust to use ksf_modules_common.
@
text
@d125 1
a125 1
				text_row($row['label'], $row['pref_name'], $this->$row['pref_name'], 20, 40);
@


1.1
log
@Initial revision
@
text
@d3 3
a5 3
require_once( 'db_base.php' );
require_once( '../../includes/purchasing/includes/po_class.inc' );	//Purchase Order (cart)
require_once( '../../includes/ui/po_ui.inc' );				//read_po
d20 4
a34 1
		$this->vendor = "COAST";
d39 1
a39 1
	function install( $redirect_to = NULL )
d44 1
a44 1
		if( isset( $redirect_to ) )
d46 1
a46 1
        		header("Location: " . $redirect_to );
a48 1
/*
a58 1
*/
a87 2
		$this->loaddbprefs();

d89 4
a92 1
    		$this->last_order_no = $this->get_pref('lastorder_no');
d94 1
a94 1
	function loaddbprefs()
d96 8
a103 8
    		// Get Host Name
        	 $this->db_Host = $this->get_pref('myhost');
    		// Get User Name
    		$this->db_User = $this->get_pref('myuser');
    		// Get Password
    		$this->db_Password = $this->get_pref('mypassword');
    		// Get DB Name
    		$this->db_Name = $this->get_pref('myname');
d107 1
a107 17
		$this->checkdbprefs();
	}
	function checkdbprefs()
	{
		if (isset($_POST['dbHost'])) $dbHost = $_POST['dbHost'];
		if (isset($_POST['dbUser'])) $dbUser = $_POST['dbUser'];
		if (isset($_POST['dbPassword'])) $dbPassword = $_POST['dbPassword'];
		if (isset($_POST['dbName'])) $dbName = $_POST['dbName'];

		if ($dbHost != $this->db_Host) // If it changed
			$this->set_pref('myhost', $dbHost);
		if ($dbUser != $this->db_User) // If it changed
			$this->set_pref('myuser', $dbUser);
		if ($dbPassword != $this->db_Password) // If it changed
			$this->set_pref('mypassword', $dbPassword);
		if ($dbName != $this->db_Name) // If it changed
			$this->set_pref('myname', $dbName);
a110 5
		$this->action_show_db_form();
		end_page();
	}
	function action_show_db_form()
	{
d113 1
a113 2

		$th = array("Function", "Description");
a114 1

a115 1

d117 10
a126 12

		label_cell("Table Status");
		if ($this->found) $table_st = "Found";
		else $table_st = "<font color=red>Not Found</font>";
		label_cell($table_st);
		end_row();

		text_row("Mysql Host", 'dbHost', $this->db_Host, 20, 40);
		text_row("User", 'dbUser', $this->db_User, 20, 40);
		text_row("Password", 'dbPassword', $this->db_Password, 20, 40);
		text_row("DB Name", 'dbName', $this->db_Name, 20, 40);

a127 2


d133 1
a133 1
		    submit_center('update', 'Update Mysql');
a134 1

d136 1
d140 7
d157 21
a185 1
		end_page();
d187 1
a187 1
	function related_tabs( $action )
d189 1
d195 1
d199 3
a201 1
				hyperlink_params($_SERVER['PHP_SELF'], 
d205 2
a207 1
			echo '&nbsp;|&nbsp;';
d210 1
a210 1
	function show_form( $action )
d212 1
d223 12
a234 1
	function base_page( $action, $help_context = "" )
d236 19
a254 9
		page(_($help_context));
		//echo __FILE__ . ":" . __LINE__ . "<br />";
		$this->tabs[1]['title'] = 'Configuration';
		$this->tabs[1]['action'] = 'config';
		$this->tabs[1]['form'] = 'action_show_form';
		$this->tabs[2]['title'] = 'Purchase Order Export';
		$this->tabs[2]['action'] = 'cexport';
		$this->tabs[2]['form'] = 'form_export';
		$this->related_tabs( $action );
@
